- project:
    templates:
      - publish-openstack-docs-pti
      - release-notes-jobs-python3
    check:
      queue: integrated
      jobs:
        - openstack-tox-pep8
        - cinderlib-tox-py36
        - cinderlib-tox-py39

        - cinderlib-lvm-functional
        - cinderlib-ceph-functional
        - cinderlib-os-brick-src-tempest-lvm-lio-barbican-yoga
    gate:
      queue: integrated
      jobs:
        - openstack-tox-pep8
        - cinderlib-tox-py36
        - cinderlib-tox-py39

        - cinderlib-lvm-functional
        - cinderlib-ceph-functional
        - cinderlib-os-brick-src-tempest-lvm-lio-barbican-yoga
    post:
      jobs:
        - publish-openstack-python-branch-tarball

- job:
    name: cinderlib-tox-py36
    parent: openstack-tox-py36
    required-projects:
      - name: openstack/os-brick
        override-checkout: stable/yoga
      - name: openstack/cinder
        override-checkout: stable/yoga
      - name: openstack/requirements
        override-checkout: stable/yoga

- job:
    name: cinderlib-tox-py39
    parent: openstack-tox-py39
    required-projects:
      - name: openstack/os-brick
        override-checkout: stable/yoga
      - name: openstack/cinder
        override-checkout: stable/yoga
      - name: openstack/requirements
        override-checkout: stable/yoga

- job:
    name: cinderlib-functional
    parent: openstack-tox-functional-with-sudo
    required-projects:
      - name: openstack/os-brick
        override-checkout: stable/yoga
      - name: openstack/cinder
        override-checkout: stable/yoga
      - name: openstack/requirements
        override-checkout: stable/yoga
    pre-run: playbooks/required-projects-bindeps.yaml
    irrelevant-files:
      - ^.*\.rst$
      - ^doc/.*$
      - ^releasenotes/.*$

- job:
    name: cinderlib-lvm-functional
    parent: cinderlib-functional
    pre-run: playbooks/setup-lvm.yaml
    nodeset: centos-8-stream
    vars:
      tox_environment:
        # Workaround for https://github.com/pypa/pip/issues/6264
        PIP_OPTIONS: "--no-use-pep517"
        CL_FTEST_MEMORY_PERSISTENCE: "false"
        # These come from great-great-grandparent tox job
        NOSE_WITH_HTML_OUTPUT: 1
        NOSE_HTML_OUT_FILE: nose_results.html
        NOSE_WITH_XUNIT: 1

# The Ceph job tests cinderlib without unnecessary libraries
- job:
    name: cinderlib-ceph-functional
    parent: cinderlib-functional
    pre-run: playbooks/setup-ceph.yaml
    # TODO: move back to centos-8 as soon as Ceph packages are available
    nodeset: ubuntu-focal
    vars:
      tox_environment:
        CL_FTEST_CFG: "{{ ansible_user_dir }}/{{ zuul.projects['opendev.org/openstack/cinderlib'].src_dir }}/cinderlib/tests/functional/ceph.yaml"
        # These come from great-great-grandparent tox job
        NOSE_WITH_HTML_OUTPUT: 1
        NOSE_HTML_OUT_FILE: nose_results.html
        NOSE_WITH_XUNIT: 1

- job:
    name: cinderlib-os-brick-src-tempest-lvm-lio-barbican-yoga
    parent: os-brick-src-tempest-lvm-lio-barbican
    description: |
      Use this job during the phase when cinderlib master is still
      the development branch of the cinder previous release.  When
      cinderlib master and cinder master are the development branches
      for the *same* release, you should use the parent job directly
      in the check and gate, above.
    override-checkout: stable/yoga
    # NOTE: while the cinderlib stable/yoga branch does not exist,
    # zuul will fall back to using cinderlib master, which is the
    # behavior we want.
